# 📊 DB 세션 풀 및 인스턴스 확장 전략 분석 보고서

이 문서는 DB 세션 풀 크기와 애플리케이션 인스턴스 수의 상관관계를 실험하고, 최적의 시스템 구성을 도출한 결과 리포트입니다.

## 1. 실험 배경 및 목적
- **배경**: 동시 접속자 수가 급증할 때 발생하는 DB 커넥션 병목 현상 및 응답 지연 문제 해결 필요.
- **목적**: 수직 확장(풀 크기 증가)과 수평 확장(인스턴스 증가) 중 FastAPI 환경에서 더 높은 성능을 내는 전략을 데이터로 검증.

## 2. 실험 시나리오 및 결과 (100 유저 부하 테스트)

| 시나리오 | 구성 (인스턴스 × 풀) | 총 커넥션 | 평균 응답 시간 | 처리량 (RPS) | 결과 분석 |
|:---:|:---|:---:|:---:|:---:|:---|
| **S1** | 1개 인스턴스 × 60 풀 | 60개 | 7,191ms | 10.9 req/s | **불가**: 단일 루프 과부하 및 컨텍스트 스위칭 지연 심각 |
| **S2** | 3개 인스턴스 × 20 풀 | 60개 | 1,600ms | 43.2 req/s | **우수**: 병렬 처리로 인해 RPS 약 4배 향상 |
| **S3** | 3개 인스턴스 × 50 풀 | 150개 | 1,800ms | 45.0 req/s | **정체**: 풀 크기만 늘리는 것은 처리량 향상에 한계가 있음 |
| **S4** | **10개 인스턴스 × 10 풀** | **100개** | **1,300ms** | **47.5 req/s** | **최적**: 가장 낮은 지연 시간과 최대 처리량 달성 |

## 3. 핵심 분석 결과 (Insight)

1. **작은 풀, 많은 인스턴스 (Small Pool, Large Scale-out)**
   - 파이썬의 싱글 스레드 이벤트 루프는 하나의 인스턴스가 대규모 풀을 관리하는 것보다, **작은 풀을 가진 여러 개의 인스턴스가 요청을 나누어 처리**할 때 비약적으로 높은 반응성을 보임 (S1 대비 S4에서 응답 속도 약 5.5배 개선).

2. **애플리케이션 병목 해소 후 DB 한계 도달**
   - 수평 확장을 통해 애플리케이션 계층의 병목은 대부분 해소되었으나, RPS 45 이상 구간에서는 **DB 서버의 물리적 I/O 처리 능력(pg_sleep 및 무거운 조회 쿼리 처리)**이 새로운 병목 지점으로 나타남.

3. **시스템 안정성 향상**
   - 인스턴스당 부하가 낮을수록 동기식 DB 작업의 성공률이 100%에 수렴하며, 특정 인스턴스 장애 시에도 시스템 전체의 가용성이 유지됨.

## 4. 최종 운영 권고 (Architecture Guide)

- **전략**: **적극적인 수평 확장(Horizontal Scaling)을 최우선**으로 채택.
- **적정 설정**:
  - 인스턴스 수: 트래픽 규모에 따라 **5~10개 이상** 유지.
  - 풀 설정: 인스턴스당 `DB_POOL_SIZE`는 **10~20** 사이로 작게 유지하여 개별 루프의 안정성 확보.
- **향후 개선**: 100% 성공률 달성을 위해 애플리케이션 튜닝을 넘어 **DB 쿼리 최적화(인덱스)** 및 **DB 서버 사양(vCPU/IOPS) 상향** 검토.
